# 🥁 Rhythm Forge Drills - Product Specification (V1.0)

## 1. 概要 (Overview)

本アプリケーションは、LLMが生成した多様なドラムパターンを、正確な楽譜表示と内蔵音源による再生を通じて反復練習するためのツールです。複雑な設定を排し、バイナリダウンロード後すぐに利用できる、シンプルなデスクトップアプリとして開発されます。

| 項目 | 詳細 |
| :--- | :--- |
| **アプリ名（仮称）** | **Rhythm Forge Drills** |
| **目的** | LLM生成パターンを用いて、**手と目の協調性**の強化と**リズムの正確な視覚化**を実現する。反復練習の効率化を最優先する。 |
| **ターゲット** | MIDI電子ドラムを持つ初心者・中級者。多様なリズムの習得を目指すユーザー。 |
| **配布形式** | **バイナリ配布**（Electron / Tauriによるデスクトップアプリ化を想定）。 |
| **開発環境** | Antigravity (JS/TSベース), Node.js, Web Audio API, **OpenSheetMusicDisplay (OSMD)**。 |
| **V1.0スコープ** | **パターン管理、内蔵音源再生、高精度楽譜表示**に限定。演奏評価機能、運指表示は含まない。**複雑な16ビート/フィルを含むサンプルパターンの実装**。 |

---

## 2. ユーザー体験 (UX) とコンテンツ管理

### 2.1. パターン管理の階層構造

練習パターンは、ブラウジングを容易にするため、以下の三層構造で管理・表示されます。

| 層 | 名称 | 目的と例 |
| :--- | :--- | :--- |
| **1. 大グループ (Group)** | 練習の**大まかなテーマ** | 例: "16 Beat", "Rudiments", "Syncopation Practice" |
| **2. サブグループ (Subgroup/Page)** | **8つのパターン**をまとめた練習単位 | 例: "16 Beat Basic 1-8", "Para diddle Drills" |
| **3. パターン (Pattern)** | 実際の演奏課題 | **原則2小節**。最小練習単位。 |

### 2.2. 練習実行画面 (8パターン表示ページ)

* **メインビュー:** サブグループに含まれる**8つのパターン**が、画面上に**2行 x 4列のグリッド**でまとめて表示されます。
* **ブラウジング:** ユーザーは「大グループ」を選び、次に「サブグループ（ページ）」をブラウズし、ページ内の8パターンを個別のロードなしに練習対象として選択できます。
* **お気に入り機能:** 大グループとは別に**「お気に入り」**だけを集めた特別なビューを提供し、ユーザーが指定したパターンを素早く呼び出せるようにする。

### 2.3. UI構成要件

* **練習実行画面の構成:**
    * **左サイドバー:** ナビゲーション（グループ、サブグループリスト、お気に入りタブ）。
    * **中央エリア:** 8つの楽譜をグリッド表示するメインエリア。クリックでアクティブなパターンを選択。
    * **下部パネル:** 再生/停止、BPM調整、ループ設定、音量などのコントロールパネル。

---

## 3. コア・データフロー (Core Data Flow)

LLMが生成したJSONデータは、以下の二つの独立したパイプラインで処理されます。

### 3.1. 🎶 再生パイプライン（内蔵音源）
`JSON` → `MIDIイベント` → `Web Audio API (サンプラー)` → **再生**

* **MIDI出力と音源:** JSONパターンをMIDIイベントに変換し、アプリに内蔵された**Web Audio APIベースのドラムサンプラー**を使用して低遅延で音を合成し、再生する。

### 3.2. 🎼 楽譜表示パイプライン（高精度）
`JSON` → `MusicXML` → `OSMD` → **ドラム譜表示**

* **レンダラー:** **OpenSheetMusicDisplay (OSMD)** を採用し、JSONデータをMusicXMLに変換してから描画することで、複雑なリズムの**記譜の正確性**を保証します。
* **検証用サンプル:** 16分音符と8分音符が混在する複雑な16ビートやフィルインを含むパターンを初期データとして用意し、**「正しく表示できること」**を早期に検証する。

---

## 4. データ構造と技術要件

### 4.1. 課題データ形式（JSONスキーマ）

LLMが生成するJSONパターンは、Git管理に適した以下の構造で定義されます。

| キー | 形式 | 説明 |
| :--- | :--- | :--- |
| `group` | String | 大グループ名 (例: "16 Beat") |
| `subgroup` | String | サブグループ名 (例: "Advanced Irregular") |
| `title` | String | 個別パターン名 |
| `bpm` | Integer | 推奨演奏テンポ |
| `time_signature` | String | 拍子 (例: "4/4") |
| `length_in_measures` | Integer | 小節数 (原則 **2**) |
| **`events`** | Array | 演奏イベントのリスト（次項参照） |

#### 演奏イベント (`events`) スキーマ

| キー | 形式 | 説明 |
| :--- | :--- | :--- |
| **`midi_note`** | Integer | 叩くべきMIDIノートナンバー (GM規格) |
| `start_time` | Float | **小節の開始からの相対時間** (4分音符=1.0) |
| `duration` | Float | MIDIノートの長さ（再生用） |
| `velocity` | Integer | 叩く強さ (0-127) |
| `hand` | String | **運指情報** ("R" or "L")。**(V1.0では表示/処理は延期)** |

### 4.2. GM MIDIノート番号の標準化

JSONの`midi_note`は、以下の**GM規格**に基づいた値を使用します。

| ドラムパート名 | GM MIDI Note # |
| :--- | :--- |
| **`kick` (BD)** | **36** |
| **`snare` (SN)** | **38** |
| **`hihat_closed` (HHC)**| **42** |
| **`hihat_open` (HHO)** | **46** |
| **`tom_floor` (FT)** | **41** |
| **`tom_mid` (T2)** | **48** |
| **`tom_high` (T1)** | **50** |
| **`ride` (RC)** | **51** |
| **`crash_a` (CR1)** | **49** |

### 4.3. MusicXML変換ロジック（高精度記譜）

* **最小クオンタイズ単位:** **16分音符**とする。JSONの相対時間（`start_time`）は、この単位で丸め込まれる。
* **休符の自動挿入:** 音符イベントのない時間軸（16分音符単位で走査）には、連続する空き時間に応じた**最適な長さの休符**（4分休符、8分休符など）を自動で計算し、MusicXMLに出力する。

---

## 5. スコープ外（V1.0では非実装）

以下の機能は、このバージョンでは開発せず、将来の拡張候補とする。

* **リアルタイム演奏評価:** 演奏されたMIDI入力に対するタイミング/ベロシティの正確性判定、スコアリング、およびフィードバック機能。
* **運指（R/L）の楽譜表示:** JSON内の`hand`情報を利用した楽譜上のR/L記号の描画。
* **課題作成エディタ:** ユーザーがGUI上でパターンを直接編集・作成する機能。
